# 琴平町地域活性化マインドマップ - 詳細設計書

## 1. モジュール詳細設計

### 1.1 main.js

#### 1.1.1 概要
アプリケーションのエントリーポイント。各モジュールの初期化と連携を管理。

#### 1.1.2 主要処理
```javascript
// アプリケーション初期化
async init() {
    1. UIローディング表示
    2. データマネージャー初期化
    3. データ読み込み（kotohira-data.json）
    4. マインドマップ初期化
    5. UIコントローラー初期化
    6. イベントリスナー設定
    7. エラーハンドリング設定
}
```

### 1.2 mindmap.js

#### 1.2.1 クラス設計
```javascript
class Mindmap {
    constructor(container, dataManager, config)
    
    // 初期化メソッド
    init()
    setupSVG()
    
    // 描画メソッド
    render(data)
    updateNodePositions()
    updateLinks()
    
    // インタラクション
    handleNodeClick(event, node)
    handleNodeRightClick(event, node)
    handleNodeDoubleClick(event, node)
    
    // ユーティリティ
    wrapText(text, width)
    calculateNodeSize(node)
    focusNode(nodeId)
}
```

#### 1.2.2 レイアウト設定
```javascript
config = {
    nodeWidth: {
        root: 200,
        major_issue: 180,
        issue: 160,
        solution: 160,
        current_effort: 160,
        success: 160
    },
    nodeHeight: {
        root: 50,
        major_issue: 45,
        issue: 40,
        solution: 40,
        current_effort: 40,
        success: 40
    },
    horizontalSpacing: 250,  // 6階層対応
    verticalSpacing: 10,
    margin: { top: 100, right: 100, bottom: 100, left: 100 }
}
```

#### 1.2.3 D3.js実装詳細
- **ツリーレイアウト**: d3.tree()を使用した水平配置
- **ノード描画**: SVG rect要素（角丸）+ text要素
- **リンク描画**: d3.linkHorizontal()によるベジェ曲線
- **ズーム/パン**: d3.zoom()による実装

### 1.3 data.js

#### 1.3.1 クラス設計
```javascript
class DataManager {
    constructor()
    
    // データ操作
    async loadData(url)
    processData(rawData)
    flattenNodes(nodes, parentId, result)
    
    // データアクセス
    getNode(nodeId)
    getChildren(nodeId)
    getParent(nodeId)
    getAncestors(nodeId)
    getDescendants(nodeId)
    
    // 検索・フィルター
    searchNodes(keyword)
    filterByType(type)
    
    // データ更新
    updateNode(nodeId, updates)
    
    // イベント管理
    addListener(callback)
    notifyListeners(event, data)
}
```

#### 1.3.2 データ処理フロー
1. JSONファイル読み込み
2. 階層構造のフラット化
3. 参考資料ノードの除外
4. 親子関係リンクの生成
5. ノードマップの構築

### 1.4 ui.js

#### 1.4.1 クラス設計
```javascript
class UIController {
    constructor(mindmap, dataManager)
    
    // 初期化
    init()
    setupElements()
    setupEventListeners()
    
    // 検索・フィルター
    handleSearch()
    handleFilter()
    clearSearch()
    
    // コントロール
    handleZoomIn()
    handleZoomOut()
    handleZoomReset()
    
    // パネル管理
    showInfoPanel(nodeData)
    updatePanelContent(nodeData)
    updateUrlsSection(nodeData)
    updateDataSection(nodeData)
    hideInfoPanel()
    
    // ツールチップ・メッセージ
    showTooltip(x, y, content)
    hideTooltip()
    showMessage(message, type)
    hideMessage()
    
    // キーボードショートカット
    handleKeyboard(e)
}
```

#### 1.4.2 URL表示処理
```javascript
updateUrlsSection(nodeData) {
    1. 複数のソースからURL収集
       - nodeData.url（単一URL）
       - nodeData.urls（URLリスト）
       - nodeData.data.url（後方互換）
    2. URL情報の整形
       - ラベル、URL、説明の取得
    3. HTMLレンダリング
       - 番号付きリスト表示
       - 外部リンク設定
}
```

## 2. データフロー設計

### 2.1 初期化フロー
```
1. index.html読み込み
2. main.js実行
3. DataManager初期化
4. kotohira-data.json読み込み
5. データ処理（参考資料ノード除外）
6. Mindmap初期化・描画
7. UIController初期化
8. ユーザー操作待機
```

### 2.2 ユーザー操作フロー

#### 2.2.1 ノードクリック
```
1. クリックイベント発生
2. Mindmap.handleNodeClick()
3. ノードの展開/折りたたみ状態切り替え
4. 子ノードの表示/非表示
5. レイアウト再計算
6. アニメーション実行
```

#### 2.2.2 テキスト編集
```
1. ダブルクリックイベント発生
2. Mindmap.handleNodeDoubleClick()
3. foreignObject要素生成
4. input要素表示
5. ユーザー入力
6. Enter/Escapeキー処理
7. DataManager.updateNode()
8. テキスト再描画
```

## 3. スタイル設計

### 3.1 カラースキーム
```css
/* ノードタイプ別カラー */
--color-root: #9b59b6;        /* 紫 */
--color-major-issue: #e74c3c; /* 赤 */
--color-issue: #e67e22;       /* オレンジ */
--color-solution: #3498db;    /* 青 */
--color-current-effort: #16a085; /* 青緑 */
--color-success: #27ae60;     /* 緑 */
```

### 3.2 レスポンシブブレークポイント
```css
/* タブレット */
@media (max-width: 1024px) {
    /* 情報パネルのオーバーレイ表示 */
    /* フォントサイズ調整 */
}

/* スマートフォン */
@media (max-width: 768px) {
    /* 縦レイアウト対応 */
    /* タッチ操作最適化 */
}
```

## 4. パフォーマンス最適化

### 4.1 レンダリング最適化
- 可視領域外のノードの非表示
- requestAnimationFrameによるアニメーション
- CSSトランジションの活用

### 4.2 イベント処理最適化
- デバウンス（検索入力: 300ms）
- スロットリング（リサイズ: 100ms）
- イベントデリゲーション

### 4.3 メモリ管理
- 不要なイベントリスナーの削除
- DOM要素の適切な破棄
- データ構造の効率化

## 5. エラーハンドリング

### 5.1 エラーパターン
1. **データ読み込みエラー**
   - ネットワークエラー
   - JSONパースエラー
   - 対応: エラーメッセージ表示、リトライ機能

2. **レンダリングエラー**
   - 無効なデータ構造
   - DOM操作エラー
   - 対応: フォールバック表示

3. **ユーザー操作エラー**
   - 無効な入力
   - 対応: バリデーション、エラーメッセージ

### 5.2 エラーログ
```javascript
console.error('Error context:', {
    module: 'module_name',
    function: 'function_name',
    error: error,
    data: relevant_data
});
```

## 6. テスト設計

### 6.1 単体テスト項目
- データ処理関数
- 検索・フィルター機能
- URL抽出処理
- テキスト折り返し処理

### 6.2 統合テスト項目
- 初期化フロー
- ユーザー操作フロー
- エラーハンドリング

### 6.3 ブラウザ互換性テスト
- Chrome（最新版）
- Firefox（最新版）
- Safari（最新版）
- Edge（最新版）

## 7. デプロイメント

### 7.1 ビルド不要
- 純粋なHTML/CSS/JavaScript
- ES6モジュール使用
- 外部依存: D3.js（CDN）

### 7.2 サーバー要件
- 静的ファイルホスティング
- HTTPS推奨
- CORS設定（データファイル用）

## 8. メンテナンス

### 8.1 データ更新
- kotohira-data.jsonの編集
- ノードIDの一意性確保
- URL情報の追加（最大5件/ノード）
- 担当者情報の管理（assigneeフィールド）

### 8.2 機能追加時の考慮事項
- モジュール間の疎結合維持
- 既存APIとの互換性
- パフォーマンスへの影響評価

## 9. 新機能実装詳細

### 9.1 コンテキストメニュー（context-menu.js）
```javascript
class ContextMenu {
    constructor(dataManager, mindmap)
    
    // メニュー管理
    show(x, y, node)
    hide()
    getMenuItems(node)
    positionMenu(x, y)
    
    // ノード操作
    showAddNodeDialog(parentNode)
    showEditNodeDialog(node)
    addNode(parentNode, nodeData)
    updateNode(node, updates)
    confirmDelete(node)
    toggleAssignee(node)  // 担当者切り替え
}
```

#### 9.1.1 メニュー項目
- 詳細を表示
- 子ノードを追加（successタイプ以外）
- テキストを編集
- ノードを編集（詳細ダイアログ）
- ノードを削除（ルート以外）
- 展開/折りたたみ
- フォーカス
- 自分の担当にする/外す（対策系ノードのみ）

### 9.2 自動保存機能（auto-save.js）
```javascript
class AutoSave {
    constructor(dataManager)
    
    // 保存管理
    saveToLocalStorage()
    restoreFromLocalStorage()
    hasSavedData()
    loadLatestData()
    clearSavedData()
    
    // 自動保存制御
    startAutoSave()  // 30秒間隔
    stopAutoSave()
    toggleAutoSave()
    
    // データ検証
    generateDataHash()
    validateData(data)
}
```

#### 9.2.1 自動保存仕様
- デフォルトで無効（isEnabled = false）
- localStorage使用
- 30秒ごとに自動保存
- データハッシュによる整合性チェック
- 24時間以内のデータは自動復元

### 9.3 データ永続化（data-persistence.js）
```javascript
class DataPersistence {
    constructor(dataManager)
    
    // エクスポート/インポート
    exportToJSON()
    importFromJSON(jsonData)
    downloadJSON(filename)
    
    // ファイル処理
    handleFileUpload(file)
    validateImportData(data)
}
```

### 9.4 URLプレビュー（url-preview.js）
```javascript
class UrlPreview {
    constructor()
    
    // プレビュー管理
    showPreview(url, element)
    hidePreview()
    attachToUrlLinks()
    
    // プレビュー生成
    createWebPreview(url)
    createPDFPreview(url)
    createImagePreview(url)
}
```

### 9.5 担当者機能

#### 9.5.1 データ構造
```javascript
// 対策系ノードのみ
{
    id: "node_xxx",
    title: "タイトル",
    type: "solution|current_effort|future_effort|success",
    assignee: "自分",  // または undefined
    status: "planned|active|completed"  // 進捗状況として使用
}
```

#### 9.5.2 視覚的識別
- active（実施中）: 金色の強調枠とドロップシャドウ、🌟アイコン
- planned（計画中）: 点線の枠、📅アイコン  
- completed（完了）: 透明度を下げて表示、✅アイコン

### 9.6 UIレイアウト最適化

#### 9.6.1 フッター設計
- 高さ: 80px（コンパクト化）
- 凡例: 横並び1行表示（フォントサイズ0.8rem）
- 操作方法: 横並び1行表示（テキスト短縮）
- レスポンシブ対応: flex-wrap使用