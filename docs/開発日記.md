# 琴平町地域活性化マインドマップ - 開発日記

## 開発概要
琴平町の地域活性化に関する情報を整理・可視化するインタラクティブなマインドマップWebアプリケーションの開発記録。

## Day 1: 初期実装

### 実装内容
- プロジェクト構造の作成
- 基本的なHTML/CSS/JavaScriptモジュールの実装
- D3.jsを使用した円形ノードのマインドマップ実装
- 中心から放射状に広がるレイアウト

### 技術選定
- **D3.js v7**: 高度なデータビジュアライゼーション
- **ES6 Modules**: コードの構造化とメンテナンス性
- **CSS Grid/Flexbox**: レスポンシブレイアウト

### 課題
- ユーザーから「円形のテキストボックスでは文字が読みにくい」とのフィードバック
- 放射状レイアウトより左から右への流れが求められた

## Day 2: レイアウト改善

### 変更内容
1. **ノード形状の変更**
   - 円形（circle）から角丸長方形（rect）へ変更
   - テキストの可読性が大幅に向上

2. **レイアウトの変更**
   - 放射状レイアウトから水平ツリーレイアウトへ
   - d3.tree()を使用した左から右への配置
   - 中心テーマを左側に配置

### 実装詳細
```javascript
// 水平レイアウトへの変更
const treeLayout = d3.tree()
    .size([height, width])
    .separation((a, b) => (a.parent == b.parent ? 1 : 2));
```

### 発生した問題
- 初期化時にエラー発生: `self`変数が未定義

## Day 3: バグ修正とレイアウト最適化

### バグ修正
- `self`変数のスコープ問題を解決
- テキスト折り返し処理の修正

### レイアウト調整
- 縦方向の間隔が広すぎる問題に対応
- 6階層のデータ構造に最適化
- 横方向の間隔を250pxに拡張

### パラメータ調整
```javascript
config = {
    horizontalSpacing: 250,  // 横間隔を拡大
    verticalSpacing: 10,     // 縦間隔を縮小
}
```

## Day 4: 機能改善

### ドラッグ機能の削除
- ユーザーフィードバック：「位置がずれて使いづらい」
- ノードのドラッグ機能を削除
- パン（画面移動）機能は維持

### テキスト編集機能の追加
- ダブルクリックでインライン編集
- SVG foreignObjectを使用した実装
- Enter保存、Escapeキャンセル

### 実装の工夫
```javascript
// foreignObjectを使用したインライン編集
const foreignObject = d3.select(currentTarget)
    .append('foreignObject')
    .attr('width', nodeWidth)
    .attr('height', nodeHeight);
```

## Day 5: 編集機能のバグ修正

### 問題
- テキスト編集をキャンセルした際、テキストが消える

### 原因
- 編集完了時のテキスト再描画処理が不完全

### 解決策
- 編集の保存/キャンセルに関わらず、常にテキストを再描画
- `updateNodeText()`を確実に呼び出す

## Day 6: データ構造の大幅更新

### データ内容の充実
- 琴平町の詳細な課題・対策データを追加
- 5つの主要課題カテゴリー
  1. 観光産業の活性化
  2. 若者の定住促進
  3. 商店街の活性化
  4. 公共交通の改善
  5. 文化財の保護と活用

### 新しいノードタイプ
- `current_effort`: 現在の取り組み（青緑色）

### スタイル追加
```css
.node.current-effort rect {
    fill: #16a085;
    stroke: #1abc9c;
}
```

## Day 7: URL管理の改善

### 要望
- 「参考文献でテキストボックスが増え、可読性が落ちている」
- 各ノードに最大5つのURLを記載できるように

### 実装内容

1. **データ構造の拡張**
   ```json
   {
     "urls": [
       {
         "label": "リンクのラベル",
         "url": "https://example.com",
         "description": "リンクの説明"
       }
     ]
   }
   ```

2. **参考資料ノードの廃止**
   - 独立した参考資料ノードを削除
   - URLは各ノードに統合
   - フィルターと凡例から参考資料を削除

3. **UI改善**
   - 情報パネルでURL一覧を番号付きで表示
   - 各URLにラベルと説明を表示
   - 外部リンクとして新しいタブで開く

### 技術的な課題と解決
- 後方互換性の維持（既存のurlフィールドもサポート）
- 複数のURLソースからの統合処理
- データ処理時の参考資料ノードフィルタリング

## 振り返り

### 成功した点
1. **ユーザビリティの向上**
   - 円形から角丸長方形への変更で可読性向上
   - 水平レイアウトで階層構造が明確に
   - インライン編集で直感的な操作

2. **柔軟なデータ構造**
   - URL管理の改善により情報の整理が向上
   - 拡張性のあるノードタイプ設計

3. **パフォーマンス**
   - 6階層のデータでも快適に動作
   - 効率的なDOM操作

### 学んだこと
1. **ユーザーフィードバックの重要性**
   - 初期の円形デザインは見た目は良いが実用性に欠けた
   - ドラッグ機能は必ずしも必要ではない

2. **D3.jsの活用**
   - foreignObjectによる柔軟なHTML統合
   - ツリーレイアウトのカスタマイズ

3. **日本語対応の考慮**
   - 文字数ベースのテキスト折り返し
   - 適切なフォント選択

### 今後の改善案
1. **機能追加**
   - データのインポート/エクスポート
   - ノードの追加/削除機能
   - 検索結果の一覧表示

2. **性能改善**
   - 大規模データ対応（仮想化）
   - アニメーションの最適化

3. **アクセシビリティ**
   - キーボード操作の充実
   - スクリーンリーダー対応

## Day 8: 高度な編集機能の実装

### 実装内容
1. **右クリックコンテキストメニュー**
   - ノードの追加・削除・編集機能
   - 展開/折りたたみ、フォーカス機能
   - 詳細情報の表示

2. **データ永続化機能**
   - JSONエクスポート/インポート
   - ファイル名に日時を含む自動命名
   - データ検証とエラーハンドリング

3. **自動保存機能**
   - localStorageを使用した30秒ごとの自動保存
   - デフォルトで無効（データ構造の問題により）
   - 保存インジケーター表示

### 技術的な課題
- ノード削除時のリンク配列の整合性維持
- 自動保存データの構造不整合問題
- キャンセルボタンのイベントリスナー問題

## Day 9: UI/UX改善とバグ修正

### テキスト編集の改善
1. **複数行編集対応**
   - inputからtextareaへ変更
   - 自動高さ調整機能
   - Ctrl+Enterで保存、Enterで改行

2. **編集体験の向上**
   - テキストエリアの自動フォーカス
   - 全選択で編集開始
   - エスケープでキャンセル

### バグ修正
1. **自動保存の無効化**
   - データ構造の不整合による問題
   - デフォルトで無効に設定
   - 手動エクスポートを推奨

2. **編集ダイアログのキャンセル問題**
   - assigneeSelectがnullの場合のエラー修正
   - 条件分岐を追加して解決

## Day 10: 担当者機能の実装

### 新機能：担当者管理
1. **データ構造の拡張**
   - assigneeフィールド追加（"自分" or undefined）
   - statusフィールドを進捗管理に活用
   - 対策系ノードのみに限定

2. **視覚的識別**
   - active（実施中）：金色の強調枠、🌟アイコン
   - planned（計画中）：点線の枠、📅アイコン
   - completed（完了）：透明度を下げて表示、✅アイコン

3. **操作方法**
   - 右クリックメニューから簡単切り替え
   - 編集ダイアログで詳細設定
   - 主要課題・課題には設定不可

### UI最適化
1. **フッターレイアウト改善**
   - 高さを100px→80pxに縮小
   - 凡例と操作方法を横並び1行表示
   - フォントサイズ調整（0.8rem）
   - レスポンシブ対応

2. **細かな調整**
   - 凡例の色見本サイズ縮小（16px）
   - 操作方法のテキスト短縮
   - 項目間の間隔最適化

## 振り返り（更新版）

### 成功した点
1. **編集機能の充実**
   - CRUD操作の完全実装
   - 直感的な右クリックメニュー
   - 複数行編集対応

2. **担当者管理機能**
   - 視覚的にわかりやすい進捗管理
   - ノードタイプに応じた適切な制限
   - シンプルな操作性

3. **UI/UXの改善**
   - コンパクトなフッターデザイン
   - 一目で分かる凡例と操作方法
   - エラーに強い実装

### 学んだこと
1. **データ整合性の重要性**
   - 自動保存時のデータ構造管理
   - ノード削除時のリンク更新
   - エラーハンドリングの必要性

2. **ユーザビリティの追求**
   - 複数行編集の需要
   - 視覚的フィードバックの重要性
   - 画面スペースの効率的活用

3. **段階的な機能実装**
   - 基本機能から徐々に拡張
   - ユーザーフィードバックの反映
   - バグ修正と機能追加のバランス

## 技術メモ

### D3.js Tips
```javascript
// テキストの中央揃え
.attr('text-anchor', 'middle')
.attr('dominant-baseline', 'central')

// 水平リンクの描画
d3.linkHorizontal()
  .x(d => d.y)
  .y(d => d.x)

// foreignObjectでのHTML要素統合
const foreignObject = d3.select(node)
    .append('foreignObject')
    .attr('width', width)
    .attr('height', height);
```

### CSS Tips
```css
/* 日本語フォントスタック */
font-family: -apple-system, BlinkMacSystemFont, 
  "Segoe UI", "Hiragino Sans", 
  "Hiragino Kaku Gothic ProN", 
  "Yu Gothic", Meiryo, sans-serif;

/* 担当ノードの視覚効果 */
.node.my-active rect {
    stroke-width: 4px !important;
    filter: drop-shadow(0 0 8px gold);
}
```

### JavaScript Tips
```javascript
// デバウンス実装
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// ユニークID生成
generateNodeId() {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substr(2, 9);
    return `node_${timestamp}_${random}`;
}
```

### localStorageの活用
```javascript
// データ保存
localStorage.setItem('key', JSON.stringify(data));

// データ読み込み
const data = JSON.parse(localStorage.getItem('key'));

// データ削除
localStorage.removeItem('key');
```